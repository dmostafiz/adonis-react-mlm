"use strict";
(self["webpackChunkadonismlm"] = self["webpackChunkadonismlm"] || []).push([["vendors-node_modules_web3auth_openlogin-adapter_dist_openloginAdapter_esm_js"],{

/***/ "./node_modules/@web3auth/openlogin-adapter/dist/openloginAdapter.esm.js":
/*!*******************************************************************************!*\
  !*** ./node_modules/@web3auth/openlogin-adapter/dist/openloginAdapter.esm.js ***!
  \*******************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "OpenloginAdapter": () => (/* binding */ OpenloginAdapter),
/* harmony export */   "getOpenloginDefaultOptions": () => (/* binding */ getOpenloginDefaultOptions)
/* harmony export */ });
/* harmony import */ var _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @toruslabs/openlogin */ "./node_modules/@toruslabs/openlogin/dist/openlogin.esm.js");
/* harmony import */ var _web3auth_base__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @web3auth/base */ "./node_modules/@web3auth/base/dist/base.esm.js");
/* harmony import */ var _babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @babel/runtime/helpers/defineProperty */ "./node_modules/@babel/runtime/helpers/esm/defineProperty.js");
/* harmony import */ var _web3auth_base_provider__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @web3auth/base-provider */ "./node_modules/@web3auth/base-provider/dist/baseProvider.esm.js");
/* harmony import */ var lodash_merge__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! lodash.merge */ "./node_modules/lodash.merge/index.js");
/* harmony import */ var lodash_merge__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(lodash_merge__WEBPACK_IMPORTED_MODULE_4__);






const getOpenloginDefaultOptions = (chainNamespace, chainId) => {
  return {
    adapterSettings: {
      network: _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__.OPENLOGIN_NETWORK.MAINNET,
      clientId: "",
      uxMode: _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__.UX_MODE.POPUP
    },
    chainConfig: chainNamespace ? (0,_web3auth_base__WEBPACK_IMPORTED_MODULE_1__.getChainConfig)(chainNamespace, chainId) : null,
    loginSettings: {}
  };
};

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
class OpenloginAdapter extends _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.BaseAdapter {
  constructor(params) {
    var _params$chainConfig, _params$chainConfig2, _params$chainConfig3;

    super();

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "name", _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WALLET_ADAPTERS.OPENLOGIN);

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "adapterNamespace", _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_NAMESPACES.MULTICHAIN);

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "type", _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_CATEGORY.IN_APP);

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "openloginInstance", null);

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "status", _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.NOT_READY);

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "currentChainNamespace", _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.EIP155);

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "openloginOptions", void 0);

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "loginSettings", {});

    (0,_babel_runtime_helpers_defineProperty__WEBPACK_IMPORTED_MODULE_2__["default"])(this, "privKeyProvider", null);

    _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.log.debug("const openlogin adapter", params);
    const defaultOptions = getOpenloginDefaultOptions((_params$chainConfig = params.chainConfig) === null || _params$chainConfig === void 0 ? void 0 : _params$chainConfig.chainNamespace, (_params$chainConfig2 = params.chainConfig) === null || _params$chainConfig2 === void 0 ? void 0 : _params$chainConfig2.chainId);
    this.openloginOptions = _objectSpread(_objectSpread({
      clientId: "",
      network: _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__.OPENLOGIN_NETWORK.MAINNET
    }, defaultOptions.adapterSettings), params.adapterSettings || {});
    this.loginSettings = _objectSpread(_objectSpread({}, defaultOptions.loginSettings), params.loginSettings); // if no chainNamespace is passed then chain config should be set before calling init

    if ((_params$chainConfig3 = params.chainConfig) !== null && _params$chainConfig3 !== void 0 && _params$chainConfig3.chainNamespace && params.chainConfig.chainNamespace !== _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.OTHER) {
      var _params$chainConfig4;

      this.currentChainNamespace = (_params$chainConfig4 = params.chainConfig) === null || _params$chainConfig4 === void 0 ? void 0 : _params$chainConfig4.chainNamespace;
      const defaultChainIdConfig = defaultOptions.chainConfig ? defaultOptions.chainConfig : {};
      this.chainConfig = _objectSpread(_objectSpread({}, defaultChainIdConfig), params === null || params === void 0 ? void 0 : params.chainConfig);
      _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.log.debug("const openlogin chainConfig", this.chainConfig);

      if (!this.chainConfig.rpcTarget) {
        throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletInitializationError.invalidParams("rpcTarget is required in chainConfig");
      }
    }
  }

  get chainConfigProxy() {
    return this.chainConfig ? _objectSpread({}, this.chainConfig) : null;
  }

  get provider() {
    var _this$privKeyProvider;

    return ((_this$privKeyProvider = this.privKeyProvider) === null || _this$privKeyProvider === void 0 ? void 0 : _this$privKeyProvider.provider) || null;
  }

  set provider(_) {
    throw new Error("Not implemented");
  }

  async init(options) {
    var _this$openloginOption;

    super.checkInitializationRequirements();
    if (!((_this$openloginOption = this.openloginOptions) !== null && _this$openloginOption !== void 0 && _this$openloginOption.clientId)) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletInitializationError.invalidParams("clientId is required before openlogin's initialization");
    if (!this.chainConfig && this.currentChainNamespace !== _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.OTHER) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletInitializationError.invalidParams("chainConfig is required before initialization");
    let isRedirectResult = false;

    if (this.openloginOptions.uxMode === _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__.UX_MODE.REDIRECT) {
      const redirectResult = (0,_toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__.getHashQueryParams)();

      if (Object.keys(redirectResult).length > 0 && redirectResult._pid) {
        isRedirectResult = true;
      }
    }

    this.openloginOptions = _objectSpread(_objectSpread({}, this.openloginOptions), {}, {
      replaceUrlOnRedirect: isRedirectResult
    });
    this.openloginInstance = new _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__["default"](this.openloginOptions);
    _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.log.debug("initializing openlogin adapter init");
    await this.openloginInstance.init();
    this.status = _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.READY;
    this.emit(_web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_EVENTS.READY, _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WALLET_ADAPTERS.OPENLOGIN);

    try {
      _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.log.debug("initializing openlogin adapter"); // connect only if it is redirect result or if connect (adapter is cached/already connected in same session) is true

      if (this.openloginInstance.privKey && (options.autoConnect || isRedirectResult)) {
        await this.connect();
      }
    } catch (error) {
      _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.log.error("Failed to connect with cached openlogin provider", error);
      this.emit("ERRORED", error);
    }
  }

  async connect(params) {
    super.checkConnectionRequirements();
    this.status = _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.CONNECTING;
    this.emit(_web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_EVENTS.CONNECTING, _objectSpread(_objectSpread({}, params), {}, {
      adapter: _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WALLET_ADAPTERS.OPENLOGIN
    }));

    try {
      await this.connectWithProvider(params);
      return this.provider;
    } catch (error) {
      _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.log.error("Failed to connect with openlogin provider", error); // ready again to be connected

      this.status = _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.READY;
      this.emit(_web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_EVENTS.ERRORED, error);

      if (error !== null && error !== void 0 && error.message.includes("user closed popup")) {
        throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletLoginError.popupClosed();
      }

      throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletLoginError.connectionError("Failed to login with openlogin");
    }
  }

  async disconnect() {
    let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {
      cleanup: false
    };
    if (this.status !== _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.CONNECTED) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletLoginError.notConnectedError("Not connected with wallet");
    if (!this.openloginInstance) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletInitializationError.notReady("openloginInstance is not ready");
    await this.openloginInstance.logout();

    if (options.cleanup) {
      this.status = _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.NOT_READY;
      this.openloginInstance = null;
      this.privKeyProvider = null;
    } else {
      // ready to be connected again
      this.status = _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.READY;
    }

    this.emit(_web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_EVENTS.DISCONNECTED);
  }

  async getUserInfo() {
    if (this.status !== _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.CONNECTED) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletLoginError.notConnectedError("Not connected with wallet");
    if (!this.openloginInstance) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletInitializationError.notReady("openloginInstance is not ready");
    const userInfo = await this.openloginInstance.getUserInfo();
    return userInfo;
  } // should be called only before initialization.


  setAdapterSettings(adapterSettings) {
    if (this.status === _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.READY) return;
    const defaultOptions = getOpenloginDefaultOptions();
    this.openloginOptions = _objectSpread(_objectSpread(_objectSpread({}, defaultOptions.adapterSettings), this.openloginOptions || {}), adapterSettings);
  } // should be called only before initialization.


  setChainConfig(customChainConfig) {
    super.setChainConfig(customChainConfig);
    this.currentChainNamespace = customChainConfig.chainNamespace;
  }

  async connectWithProvider(params) {
    if (!this.chainConfig) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletInitializationError.invalidParams("chainConfig is required before initialization");
    if (!this.openloginInstance) throw _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WalletInitializationError.notReady("openloginInstance is not ready");

    if (this.currentChainNamespace === _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.SOLANA) {
      const {
        SolanaPrivateKeyProvider
      } = await Promise.all(/*! import() */[__webpack_require__.e("vendors-node_modules_toruslabs_tweetnacl-js_nacl-fast_js"), __webpack_require__.e("vendors-node_modules_web3auth_solana-provider_dist_solanaProvider_esm_js"), __webpack_require__.e("_6c05-_0b24-_1ce7-_866b")]).then(__webpack_require__.bind(__webpack_require__, /*! @web3auth/solana-provider */ "./node_modules/@web3auth/solana-provider/dist/solanaProvider.esm.js"));
      this.privKeyProvider = new SolanaPrivateKeyProvider({
        config: {
          chainConfig: this.chainConfig
        }
      });
    } else if (this.currentChainNamespace === _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.EIP155) {
      const {
        EthereumPrivateKeyProvider
      } = await Promise.all(/*! import() */[__webpack_require__.e("vendors-node_modules_web3auth_ethereum-provider_dist_ethereumProvider_esm_js"), __webpack_require__.e("_a993")]).then(__webpack_require__.bind(__webpack_require__, /*! @web3auth/ethereum-provider */ "./node_modules/@web3auth/ethereum-provider/dist/ethereumProvider.esm.js"));
      this.privKeyProvider = new EthereumPrivateKeyProvider({
        config: {
          chainConfig: this.chainConfig
        }
      });
    } else if (this.currentChainNamespace === _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.OTHER) {
      this.privKeyProvider = new _web3auth_base_provider__WEBPACK_IMPORTED_MODULE_3__.CommonPrivateKeyProvider();
    } else {
      throw new Error("Invalid chainNamespace: ".concat(this.currentChainNamespace, " found while connecting to wallet"));
    } // if not logged in then login


    if (!this.openloginInstance.privKey && params) {
      var _params$extraLoginOpt;

      if (!this.loginSettings.curve) {
        this.loginSettings.curve = this.currentChainNamespace === _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.SOLANA ? _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__.SUPPORTED_KEY_CURVES.ED25519 : _toruslabs_openlogin__WEBPACK_IMPORTED_MODULE_0__.SUPPORTED_KEY_CURVES.SECP256K1;
      }

      await this.openloginInstance.login(lodash_merge__WEBPACK_IMPORTED_MODULE_4___default()(this.loginSettings, {
        loginProvider: params.loginProvider
      }, {
        extraLoginOptions: _objectSpread(_objectSpread({}, params.extraLoginOptions || {}), {}, {
          login_hint: params.login_hint || ((_params$extraLoginOpt = params.extraLoginOptions) === null || _params$extraLoginOpt === void 0 ? void 0 : _params$extraLoginOpt.login_hint)
        })
      }));
    }

    let finalPrivKey = this.openloginInstance.privKey;

    if (finalPrivKey) {
      if (this.currentChainNamespace === _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.CHAIN_NAMESPACES.SOLANA) {
        const {
          getED25519Key
        } = await Promise.all(/*! import() */[__webpack_require__.e("vendors-node_modules_toruslabs_tweetnacl-js_nacl-fast_js"), __webpack_require__.e("node_modules_toruslabs_openlogin-ed25519_dist_openloginEd25519_esm_js")]).then(__webpack_require__.bind(__webpack_require__, /*! @toruslabs/openlogin-ed25519 */ "./node_modules/@toruslabs/openlogin-ed25519/dist/openloginEd25519.esm.js"));
        finalPrivKey = getED25519Key(finalPrivKey).sk.toString("hex");
      }

      await this.privKeyProvider.setupProvider(finalPrivKey);
      this.status = _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_STATUS.CONNECTED;
      this.emit(_web3auth_base__WEBPACK_IMPORTED_MODULE_1__.ADAPTER_EVENTS.CONNECTED, {
        adapter: _web3auth_base__WEBPACK_IMPORTED_MODULE_1__.WALLET_ADAPTERS.OPENLOGIN,
        reconnected: !params
      });
    }
  }

}


//# sourceMappingURL=openloginAdapter.esm.js.map


/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVuZG9ycy1ub2RlX21vZHVsZXNfd2ViM2F1dGhfb3BlbmxvZ2luLWFkYXB0ZXJfZGlzdF9vcGVubG9naW5BZGFwdGVyX2VzbV9qcy5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUF1SDtBQUNpRztBQUNwSjtBQUNEO0FBQ2xDOztBQUVqQztBQUNBO0FBQ0E7QUFDQSxlQUFlLDJFQUF5QjtBQUN4QztBQUNBLGNBQWMsK0RBQWE7QUFDM0IsS0FBSztBQUNMLGtDQUFrQyw4REFBYztBQUNoRDtBQUNBO0FBQ0E7O0FBRUEsMkNBQTJDLGdDQUFnQyxvQ0FBb0Msb0RBQW9ELDZEQUE2RCxpRUFBaUUsc0NBQXNDOztBQUV2VSxpQ0FBaUMsZ0JBQWdCLHNCQUFzQixPQUFPLHVEQUF1RCw2REFBNkQsaUZBQWUsNkJBQTZCLG9LQUFvSyxtRkFBbUYsS0FBSztBQUMxZSwrQkFBK0IsdURBQVc7QUFDMUM7QUFDQTs7QUFFQTs7QUFFQSxJQUFJLGlGQUFlLGVBQWUscUVBQXlCOztBQUUzRCxJQUFJLGlGQUFlLDJCQUEyQix5RUFBNkI7O0FBRTNFLElBQUksaUZBQWUsZUFBZSxtRUFBdUI7O0FBRXpELElBQUksaUZBQWU7O0FBRW5CLElBQUksaUZBQWUsaUJBQWlCLG9FQUF3Qjs7QUFFNUQsSUFBSSxpRkFBZSxnQ0FBZ0MsbUVBQXVCOztBQUUxRSxJQUFJLGlGQUFlOztBQUVuQixJQUFJLGlGQUFlLDBCQUEwQjs7QUFFN0MsSUFBSSxpRkFBZTs7QUFFbkIsSUFBSSxxREFBUztBQUNiO0FBQ0E7QUFDQTtBQUNBLGVBQWUsMkVBQXlCO0FBQ3hDLEtBQUssK0RBQStEO0FBQ3BFLHVEQUF1RCx3REFBd0Q7O0FBRS9HLGdMQUFnTCxrRUFBc0I7QUFDdE07O0FBRUE7QUFDQTtBQUNBLHVEQUF1RDtBQUN2RCxNQUFNLHFEQUFTOztBQUVmO0FBQ0EsY0FBYyxtRkFBdUM7QUFDckQ7QUFDQTtBQUNBOztBQUVBO0FBQ0EsOENBQThDO0FBQzlDOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBLGlKQUFpSixtRkFBdUM7QUFDeEwsNERBQTRELGtFQUFzQixRQUFRLG1GQUF1QztBQUNqSTs7QUFFQSx5Q0FBeUMsa0VBQWdCO0FBQ3pELDZCQUE2Qix3RUFBa0I7O0FBRS9DO0FBQ0E7QUFDQTtBQUNBOztBQUVBLDBEQUEwRCw0QkFBNEI7QUFDdEY7QUFDQSxLQUFLO0FBQ0wsaUNBQWlDLDREQUFTO0FBQzFDLElBQUkscURBQVM7QUFDYjtBQUNBLGtCQUFrQixnRUFBb0I7QUFDdEMsY0FBYyxnRUFBb0IsRUFBRSxxRUFBeUI7O0FBRTdEO0FBQ0EsTUFBTSxxREFBUyxvQ0FBb0M7O0FBRW5EO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTixNQUFNLHFEQUFTO0FBQ2Y7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQSxrQkFBa0IscUVBQXlCO0FBQzNDLGNBQWMscUVBQXlCLGdDQUFnQyxhQUFhO0FBQ3BGLGVBQWUscUVBQXlCO0FBQ3hDLEtBQUs7O0FBRUw7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOLE1BQU0scURBQVMsc0RBQXNEOztBQUVyRSxvQkFBb0IsZ0VBQW9CO0FBQ3hDLGdCQUFnQixrRUFBc0I7O0FBRXRDO0FBQ0EsY0FBYyx3RUFBNEI7QUFDMUM7O0FBRUEsWUFBWSw0RUFBZ0M7QUFDNUM7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QixvRUFBd0IsUUFBUSw4RUFBa0M7QUFDMUYsdUNBQXVDLDhFQUFrQztBQUN6RTs7QUFFQTtBQUNBLG9CQUFvQixvRUFBd0I7QUFDNUM7QUFDQTtBQUNBLE1BQU07QUFDTjtBQUNBLG9CQUFvQixnRUFBb0I7QUFDeEM7O0FBRUEsY0FBYyx1RUFBMkI7QUFDekM7O0FBRUE7QUFDQSx3QkFBd0Isb0VBQXdCLFFBQVEsOEVBQWtDO0FBQzFGLHVDQUF1Qyw4RUFBa0M7QUFDekU7QUFDQTtBQUNBLElBQUk7OztBQUdKO0FBQ0Esd0JBQXdCLGdFQUFvQjtBQUM1QztBQUNBLHdFQUF3RSw4REFBOEQ7QUFDdEksSUFBSTs7O0FBR0o7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxpQ0FBaUMsbUZBQXVDO0FBQ3hFLHVDQUF1Qyw4RUFBa0M7O0FBRXpFLHVDQUF1QyxtRUFBdUI7QUFDOUQ7QUFDQTtBQUNBLFFBQVEsUUFBUSxnYUFBbUM7QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1AsTUFBTSx3Q0FBd0MsbUVBQXVCO0FBQ3JFO0FBQ0E7QUFDQSxRQUFRLFFBQVEscVVBQXFDO0FBQ3JEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQLE1BQU0sd0NBQXdDLGtFQUFzQjtBQUNwRSxpQ0FBaUMsNkVBQXdCO0FBQ3pELE1BQU07QUFDTjtBQUNBLE1BQU07OztBQUdOO0FBQ0E7O0FBRUE7QUFDQSxrRUFBa0UsbUVBQXVCLEdBQUcsOEVBQTRCLEdBQUcsZ0ZBQThCO0FBQ3pKOztBQUVBLHlDQUF5QyxtREFBSztBQUM5QztBQUNBLE9BQU87QUFDUCx5REFBeUQsZ0NBQWdDLEtBQUs7QUFDOUY7QUFDQSxTQUFTO0FBQ1QsT0FBTztBQUNQOztBQUVBOztBQUVBO0FBQ0EseUNBQXlDLG1FQUF1QjtBQUNoRTtBQUNBO0FBQ0EsVUFBVSxRQUFRLG1YQUFzQztBQUN4RDtBQUNBOztBQUVBO0FBQ0Esb0JBQW9CLG9FQUF3QjtBQUM1QyxnQkFBZ0Isb0VBQXdCO0FBQ3hDLGlCQUFpQixxRUFBeUI7QUFDMUM7QUFDQSxPQUFPO0FBQ1A7QUFDQTs7QUFFQTs7QUFFd0Q7QUFDeEQiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9hZG9uaXNtbG0vLi9ub2RlX21vZHVsZXMvQHdlYjNhdXRoL29wZW5sb2dpbi1hZGFwdGVyL2Rpc3Qvb3BlbmxvZ2luQWRhcHRlci5lc20uanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9wZW5Mb2dpbiwgeyBPUEVOTE9HSU5fTkVUV09SSywgVVhfTU9ERSwgZ2V0SGFzaFF1ZXJ5UGFyYW1zLCBTVVBQT1JURURfS0VZX0NVUlZFUyB9IGZyb20gJ0B0b3J1c2xhYnMvb3BlbmxvZ2luJztcbmltcG9ydCB7IGdldENoYWluQ29uZmlnLCBCYXNlQWRhcHRlciwgV0FMTEVUX0FEQVBURVJTLCBBREFQVEVSX05BTUVTUEFDRVMsIEFEQVBURVJfQ0FURUdPUlksIEFEQVBURVJfU1RBVFVTLCBDSEFJTl9OQU1FU1BBQ0VTLCBsb2csIFdhbGxldEluaXRpYWxpemF0aW9uRXJyb3IsIEFEQVBURVJfRVZFTlRTLCBXYWxsZXRMb2dpbkVycm9yIH0gZnJvbSAnQHdlYjNhdXRoL2Jhc2UnO1xuaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICdAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5JztcbmltcG9ydCB7IENvbW1vblByaXZhdGVLZXlQcm92aWRlciB9IGZyb20gJ0B3ZWIzYXV0aC9iYXNlLXByb3ZpZGVyJztcbmltcG9ydCBtZXJnZSBmcm9tICdsb2Rhc2gubWVyZ2UnO1xuXG5jb25zdCBnZXRPcGVubG9naW5EZWZhdWx0T3B0aW9ucyA9IChjaGFpbk5hbWVzcGFjZSwgY2hhaW5JZCkgPT4ge1xuICByZXR1cm4ge1xuICAgIGFkYXB0ZXJTZXR0aW5nczoge1xuICAgICAgbmV0d29yazogT1BFTkxPR0lOX05FVFdPUksuTUFJTk5FVCxcbiAgICAgIGNsaWVudElkOiBcIlwiLFxuICAgICAgdXhNb2RlOiBVWF9NT0RFLlBPUFVQXG4gICAgfSxcbiAgICBjaGFpbkNvbmZpZzogY2hhaW5OYW1lc3BhY2UgPyBnZXRDaGFpbkNvbmZpZyhjaGFpbk5hbWVzcGFjZSwgY2hhaW5JZCkgOiBudWxsLFxuICAgIGxvZ2luU2V0dGluZ3M6IHt9XG4gIH07XG59O1xuXG5mdW5jdGlvbiBvd25LZXlzKG9iamVjdCwgZW51bWVyYWJsZU9ubHkpIHsgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmplY3QpOyBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgeyB2YXIgc3ltYm9scyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMob2JqZWN0KTsgZW51bWVyYWJsZU9ubHkgJiYgKHN5bWJvbHMgPSBzeW1ib2xzLmZpbHRlcihmdW5jdGlvbiAoc3ltKSB7IHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgc3ltKS5lbnVtZXJhYmxlOyB9KSksIGtleXMucHVzaC5hcHBseShrZXlzLCBzeW1ib2xzKTsgfSByZXR1cm4ga2V5czsgfVxuXG5mdW5jdGlvbiBfb2JqZWN0U3ByZWFkKHRhcmdldCkgeyBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgeyB2YXIgc291cmNlID0gbnVsbCAhPSBhcmd1bWVudHNbaV0gPyBhcmd1bWVudHNbaV0gOiB7fTsgaSAlIDIgPyBvd25LZXlzKE9iamVjdChzb3VyY2UpLCAhMCkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IF9kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc291cmNlW2tleV0pOyB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhzb3VyY2UpKSA6IG93bktleXMoT2JqZWN0KHNvdXJjZSkpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBrZXkpKTsgfSk7IH0gcmV0dXJuIHRhcmdldDsgfVxuY2xhc3MgT3BlbmxvZ2luQWRhcHRlciBleHRlbmRzIEJhc2VBZGFwdGVyIHtcbiAgY29uc3RydWN0b3IocGFyYW1zKSB7XG4gICAgdmFyIF9wYXJhbXMkY2hhaW5Db25maWcsIF9wYXJhbXMkY2hhaW5Db25maWcyLCBfcGFyYW1zJGNoYWluQ29uZmlnMztcblxuICAgIHN1cGVyKCk7XG5cbiAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgXCJuYW1lXCIsIFdBTExFVF9BREFQVEVSUy5PUEVOTE9HSU4pO1xuXG4gICAgX2RlZmluZVByb3BlcnR5KHRoaXMsIFwiYWRhcHRlck5hbWVzcGFjZVwiLCBBREFQVEVSX05BTUVTUEFDRVMuTVVMVElDSEFJTik7XG5cbiAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgXCJ0eXBlXCIsIEFEQVBURVJfQ0FURUdPUlkuSU5fQVBQKTtcblxuICAgIF9kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcIm9wZW5sb2dpbkluc3RhbmNlXCIsIG51bGwpO1xuXG4gICAgX2RlZmluZVByb3BlcnR5KHRoaXMsIFwic3RhdHVzXCIsIEFEQVBURVJfU1RBVFVTLk5PVF9SRUFEWSk7XG5cbiAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgXCJjdXJyZW50Q2hhaW5OYW1lc3BhY2VcIiwgQ0hBSU5fTkFNRVNQQUNFUy5FSVAxNTUpO1xuXG4gICAgX2RlZmluZVByb3BlcnR5KHRoaXMsIFwib3BlbmxvZ2luT3B0aW9uc1wiLCB2b2lkIDApO1xuXG4gICAgX2RlZmluZVByb3BlcnR5KHRoaXMsIFwibG9naW5TZXR0aW5nc1wiLCB7fSk7XG5cbiAgICBfZGVmaW5lUHJvcGVydHkodGhpcywgXCJwcml2S2V5UHJvdmlkZXJcIiwgbnVsbCk7XG5cbiAgICBsb2cuZGVidWcoXCJjb25zdCBvcGVubG9naW4gYWRhcHRlclwiLCBwYXJhbXMpO1xuICAgIGNvbnN0IGRlZmF1bHRPcHRpb25zID0gZ2V0T3BlbmxvZ2luRGVmYXVsdE9wdGlvbnMoKF9wYXJhbXMkY2hhaW5Db25maWcgPSBwYXJhbXMuY2hhaW5Db25maWcpID09PSBudWxsIHx8IF9wYXJhbXMkY2hhaW5Db25maWcgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wYXJhbXMkY2hhaW5Db25maWcuY2hhaW5OYW1lc3BhY2UsIChfcGFyYW1zJGNoYWluQ29uZmlnMiA9IHBhcmFtcy5jaGFpbkNvbmZpZykgPT09IG51bGwgfHwgX3BhcmFtcyRjaGFpbkNvbmZpZzIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wYXJhbXMkY2hhaW5Db25maWcyLmNoYWluSWQpO1xuICAgIHRoaXMub3BlbmxvZ2luT3B0aW9ucyA9IF9vYmplY3RTcHJlYWQoX29iamVjdFNwcmVhZCh7XG4gICAgICBjbGllbnRJZDogXCJcIixcbiAgICAgIG5ldHdvcms6IE9QRU5MT0dJTl9ORVRXT1JLLk1BSU5ORVRcbiAgICB9LCBkZWZhdWx0T3B0aW9ucy5hZGFwdGVyU2V0dGluZ3MpLCBwYXJhbXMuYWRhcHRlclNldHRpbmdzIHx8IHt9KTtcbiAgICB0aGlzLmxvZ2luU2V0dGluZ3MgPSBfb2JqZWN0U3ByZWFkKF9vYmplY3RTcHJlYWQoe30sIGRlZmF1bHRPcHRpb25zLmxvZ2luU2V0dGluZ3MpLCBwYXJhbXMubG9naW5TZXR0aW5ncyk7IC8vIGlmIG5vIGNoYWluTmFtZXNwYWNlIGlzIHBhc3NlZCB0aGVuIGNoYWluIGNvbmZpZyBzaG91bGQgYmUgc2V0IGJlZm9yZSBjYWxsaW5nIGluaXRcblxuICAgIGlmICgoX3BhcmFtcyRjaGFpbkNvbmZpZzMgPSBwYXJhbXMuY2hhaW5Db25maWcpICE9PSBudWxsICYmIF9wYXJhbXMkY2hhaW5Db25maWczICE9PSB2b2lkIDAgJiYgX3BhcmFtcyRjaGFpbkNvbmZpZzMuY2hhaW5OYW1lc3BhY2UgJiYgcGFyYW1zLmNoYWluQ29uZmlnLmNoYWluTmFtZXNwYWNlICE9PSBDSEFJTl9OQU1FU1BBQ0VTLk9USEVSKSB7XG4gICAgICB2YXIgX3BhcmFtcyRjaGFpbkNvbmZpZzQ7XG5cbiAgICAgIHRoaXMuY3VycmVudENoYWluTmFtZXNwYWNlID0gKF9wYXJhbXMkY2hhaW5Db25maWc0ID0gcGFyYW1zLmNoYWluQ29uZmlnKSA9PT0gbnVsbCB8fCBfcGFyYW1zJGNoYWluQ29uZmlnNCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3BhcmFtcyRjaGFpbkNvbmZpZzQuY2hhaW5OYW1lc3BhY2U7XG4gICAgICBjb25zdCBkZWZhdWx0Q2hhaW5JZENvbmZpZyA9IGRlZmF1bHRPcHRpb25zLmNoYWluQ29uZmlnID8gZGVmYXVsdE9wdGlvbnMuY2hhaW5Db25maWcgOiB7fTtcbiAgICAgIHRoaXMuY2hhaW5Db25maWcgPSBfb2JqZWN0U3ByZWFkKF9vYmplY3RTcHJlYWQoe30sIGRlZmF1bHRDaGFpbklkQ29uZmlnKSwgcGFyYW1zID09PSBudWxsIHx8IHBhcmFtcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFyYW1zLmNoYWluQ29uZmlnKTtcbiAgICAgIGxvZy5kZWJ1ZyhcImNvbnN0IG9wZW5sb2dpbiBjaGFpbkNvbmZpZ1wiLCB0aGlzLmNoYWluQ29uZmlnKTtcblxuICAgICAgaWYgKCF0aGlzLmNoYWluQ29uZmlnLnJwY1RhcmdldCkge1xuICAgICAgICB0aHJvdyBXYWxsZXRJbml0aWFsaXphdGlvbkVycm9yLmludmFsaWRQYXJhbXMoXCJycGNUYXJnZXQgaXMgcmVxdWlyZWQgaW4gY2hhaW5Db25maWdcIik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0IGNoYWluQ29uZmlnUHJveHkoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2hhaW5Db25maWcgPyBfb2JqZWN0U3ByZWFkKHt9LCB0aGlzLmNoYWluQ29uZmlnKSA6IG51bGw7XG4gIH1cblxuICBnZXQgcHJvdmlkZXIoKSB7XG4gICAgdmFyIF90aGlzJHByaXZLZXlQcm92aWRlcjtcblxuICAgIHJldHVybiAoKF90aGlzJHByaXZLZXlQcm92aWRlciA9IHRoaXMucHJpdktleVByb3ZpZGVyKSA9PT0gbnVsbCB8fCBfdGhpcyRwcml2S2V5UHJvdmlkZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByaXZLZXlQcm92aWRlci5wcm92aWRlcikgfHwgbnVsbDtcbiAgfVxuXG4gIHNldCBwcm92aWRlcihfKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkXCIpO1xuICB9XG5cbiAgYXN5bmMgaW5pdChvcHRpb25zKSB7XG4gICAgdmFyIF90aGlzJG9wZW5sb2dpbk9wdGlvbjtcblxuICAgIHN1cGVyLmNoZWNrSW5pdGlhbGl6YXRpb25SZXF1aXJlbWVudHMoKTtcbiAgICBpZiAoISgoX3RoaXMkb3BlbmxvZ2luT3B0aW9uID0gdGhpcy5vcGVubG9naW5PcHRpb25zKSAhPT0gbnVsbCAmJiBfdGhpcyRvcGVubG9naW5PcHRpb24gIT09IHZvaWQgMCAmJiBfdGhpcyRvcGVubG9naW5PcHRpb24uY2xpZW50SWQpKSB0aHJvdyBXYWxsZXRJbml0aWFsaXphdGlvbkVycm9yLmludmFsaWRQYXJhbXMoXCJjbGllbnRJZCBpcyByZXF1aXJlZCBiZWZvcmUgb3BlbmxvZ2luJ3MgaW5pdGlhbGl6YXRpb25cIik7XG4gICAgaWYgKCF0aGlzLmNoYWluQ29uZmlnICYmIHRoaXMuY3VycmVudENoYWluTmFtZXNwYWNlICE9PSBDSEFJTl9OQU1FU1BBQ0VTLk9USEVSKSB0aHJvdyBXYWxsZXRJbml0aWFsaXphdGlvbkVycm9yLmludmFsaWRQYXJhbXMoXCJjaGFpbkNvbmZpZyBpcyByZXF1aXJlZCBiZWZvcmUgaW5pdGlhbGl6YXRpb25cIik7XG4gICAgbGV0IGlzUmVkaXJlY3RSZXN1bHQgPSBmYWxzZTtcblxuICAgIGlmICh0aGlzLm9wZW5sb2dpbk9wdGlvbnMudXhNb2RlID09PSBVWF9NT0RFLlJFRElSRUNUKSB7XG4gICAgICBjb25zdCByZWRpcmVjdFJlc3VsdCA9IGdldEhhc2hRdWVyeVBhcmFtcygpO1xuXG4gICAgICBpZiAoT2JqZWN0LmtleXMocmVkaXJlY3RSZXN1bHQpLmxlbmd0aCA+IDAgJiYgcmVkaXJlY3RSZXN1bHQuX3BpZCkge1xuICAgICAgICBpc1JlZGlyZWN0UmVzdWx0ID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLm9wZW5sb2dpbk9wdGlvbnMgPSBfb2JqZWN0U3ByZWFkKF9vYmplY3RTcHJlYWQoe30sIHRoaXMub3BlbmxvZ2luT3B0aW9ucyksIHt9LCB7XG4gICAgICByZXBsYWNlVXJsT25SZWRpcmVjdDogaXNSZWRpcmVjdFJlc3VsdFxuICAgIH0pO1xuICAgIHRoaXMub3BlbmxvZ2luSW5zdGFuY2UgPSBuZXcgT3BlbkxvZ2luKHRoaXMub3BlbmxvZ2luT3B0aW9ucyk7XG4gICAgbG9nLmRlYnVnKFwiaW5pdGlhbGl6aW5nIG9wZW5sb2dpbiBhZGFwdGVyIGluaXRcIik7XG4gICAgYXdhaXQgdGhpcy5vcGVubG9naW5JbnN0YW5jZS5pbml0KCk7XG4gICAgdGhpcy5zdGF0dXMgPSBBREFQVEVSX1NUQVRVUy5SRUFEWTtcbiAgICB0aGlzLmVtaXQoQURBUFRFUl9FVkVOVFMuUkVBRFksIFdBTExFVF9BREFQVEVSUy5PUEVOTE9HSU4pO1xuXG4gICAgdHJ5IHtcbiAgICAgIGxvZy5kZWJ1ZyhcImluaXRpYWxpemluZyBvcGVubG9naW4gYWRhcHRlclwiKTsgLy8gY29ubmVjdCBvbmx5IGlmIGl0IGlzIHJlZGlyZWN0IHJlc3VsdCBvciBpZiBjb25uZWN0IChhZGFwdGVyIGlzIGNhY2hlZC9hbHJlYWR5IGNvbm5lY3RlZCBpbiBzYW1lIHNlc3Npb24pIGlzIHRydWVcblxuICAgICAgaWYgKHRoaXMub3BlbmxvZ2luSW5zdGFuY2UucHJpdktleSAmJiAob3B0aW9ucy5hdXRvQ29ubmVjdCB8fCBpc1JlZGlyZWN0UmVzdWx0KSkge1xuICAgICAgICBhd2FpdCB0aGlzLmNvbm5lY3QoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nLmVycm9yKFwiRmFpbGVkIHRvIGNvbm5lY3Qgd2l0aCBjYWNoZWQgb3BlbmxvZ2luIHByb3ZpZGVyXCIsIGVycm9yKTtcbiAgICAgIHRoaXMuZW1pdChcIkVSUk9SRURcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QocGFyYW1zKSB7XG4gICAgc3VwZXIuY2hlY2tDb25uZWN0aW9uUmVxdWlyZW1lbnRzKCk7XG4gICAgdGhpcy5zdGF0dXMgPSBBREFQVEVSX1NUQVRVUy5DT05ORUNUSU5HO1xuICAgIHRoaXMuZW1pdChBREFQVEVSX0VWRU5UUy5DT05ORUNUSU5HLCBfb2JqZWN0U3ByZWFkKF9vYmplY3RTcHJlYWQoe30sIHBhcmFtcyksIHt9LCB7XG4gICAgICBhZGFwdGVyOiBXQUxMRVRfQURBUFRFUlMuT1BFTkxPR0lOXG4gICAgfSkpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuY29ubmVjdFdpdGhQcm92aWRlcihwYXJhbXMpO1xuICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZy5lcnJvcihcIkZhaWxlZCB0byBjb25uZWN0IHdpdGggb3BlbmxvZ2luIHByb3ZpZGVyXCIsIGVycm9yKTsgLy8gcmVhZHkgYWdhaW4gdG8gYmUgY29ubmVjdGVkXG5cbiAgICAgIHRoaXMuc3RhdHVzID0gQURBUFRFUl9TVEFUVVMuUkVBRFk7XG4gICAgICB0aGlzLmVtaXQoQURBUFRFUl9FVkVOVFMuRVJST1JFRCwgZXJyb3IpO1xuXG4gICAgICBpZiAoZXJyb3IgIT09IG51bGwgJiYgZXJyb3IgIT09IHZvaWQgMCAmJiBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKFwidXNlciBjbG9zZWQgcG9wdXBcIikpIHtcbiAgICAgICAgdGhyb3cgV2FsbGV0TG9naW5FcnJvci5wb3B1cENsb3NlZCgpO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBXYWxsZXRMb2dpbkVycm9yLmNvbm5lY3Rpb25FcnJvcihcIkZhaWxlZCB0byBsb2dpbiB3aXRoIG9wZW5sb2dpblwiKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkaXNjb25uZWN0KCkge1xuICAgIGxldCBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7XG4gICAgICBjbGVhbnVwOiBmYWxzZVxuICAgIH07XG4gICAgaWYgKHRoaXMuc3RhdHVzICE9PSBBREFQVEVSX1NUQVRVUy5DT05ORUNURUQpIHRocm93IFdhbGxldExvZ2luRXJyb3Iubm90Q29ubmVjdGVkRXJyb3IoXCJOb3QgY29ubmVjdGVkIHdpdGggd2FsbGV0XCIpO1xuICAgIGlmICghdGhpcy5vcGVubG9naW5JbnN0YW5jZSkgdGhyb3cgV2FsbGV0SW5pdGlhbGl6YXRpb25FcnJvci5ub3RSZWFkeShcIm9wZW5sb2dpbkluc3RhbmNlIGlzIG5vdCByZWFkeVwiKTtcbiAgICBhd2FpdCB0aGlzLm9wZW5sb2dpbkluc3RhbmNlLmxvZ291dCgpO1xuXG4gICAgaWYgKG9wdGlvbnMuY2xlYW51cCkge1xuICAgICAgdGhpcy5zdGF0dXMgPSBBREFQVEVSX1NUQVRVUy5OT1RfUkVBRFk7XG4gICAgICB0aGlzLm9wZW5sb2dpbkluc3RhbmNlID0gbnVsbDtcbiAgICAgIHRoaXMucHJpdktleVByb3ZpZGVyID0gbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gcmVhZHkgdG8gYmUgY29ubmVjdGVkIGFnYWluXG4gICAgICB0aGlzLnN0YXR1cyA9IEFEQVBURVJfU1RBVFVTLlJFQURZO1xuICAgIH1cblxuICAgIHRoaXMuZW1pdChBREFQVEVSX0VWRU5UUy5ESVNDT05ORUNURUQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0VXNlckluZm8oKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzICE9PSBBREFQVEVSX1NUQVRVUy5DT05ORUNURUQpIHRocm93IFdhbGxldExvZ2luRXJyb3Iubm90Q29ubmVjdGVkRXJyb3IoXCJOb3QgY29ubmVjdGVkIHdpdGggd2FsbGV0XCIpO1xuICAgIGlmICghdGhpcy5vcGVubG9naW5JbnN0YW5jZSkgdGhyb3cgV2FsbGV0SW5pdGlhbGl6YXRpb25FcnJvci5ub3RSZWFkeShcIm9wZW5sb2dpbkluc3RhbmNlIGlzIG5vdCByZWFkeVwiKTtcbiAgICBjb25zdCB1c2VySW5mbyA9IGF3YWl0IHRoaXMub3BlbmxvZ2luSW5zdGFuY2UuZ2V0VXNlckluZm8oKTtcbiAgICByZXR1cm4gdXNlckluZm87XG4gIH0gLy8gc2hvdWxkIGJlIGNhbGxlZCBvbmx5IGJlZm9yZSBpbml0aWFsaXphdGlvbi5cblxuXG4gIHNldEFkYXB0ZXJTZXR0aW5ncyhhZGFwdGVyU2V0dGluZ3MpIHtcbiAgICBpZiAodGhpcy5zdGF0dXMgPT09IEFEQVBURVJfU1RBVFVTLlJFQURZKSByZXR1cm47XG4gICAgY29uc3QgZGVmYXVsdE9wdGlvbnMgPSBnZXRPcGVubG9naW5EZWZhdWx0T3B0aW9ucygpO1xuICAgIHRoaXMub3BlbmxvZ2luT3B0aW9ucyA9IF9vYmplY3RTcHJlYWQoX29iamVjdFNwcmVhZChfb2JqZWN0U3ByZWFkKHt9LCBkZWZhdWx0T3B0aW9ucy5hZGFwdGVyU2V0dGluZ3MpLCB0aGlzLm9wZW5sb2dpbk9wdGlvbnMgfHwge30pLCBhZGFwdGVyU2V0dGluZ3MpO1xuICB9IC8vIHNob3VsZCBiZSBjYWxsZWQgb25seSBiZWZvcmUgaW5pdGlhbGl6YXRpb24uXG5cblxuICBzZXRDaGFpbkNvbmZpZyhjdXN0b21DaGFpbkNvbmZpZykge1xuICAgIHN1cGVyLnNldENoYWluQ29uZmlnKGN1c3RvbUNoYWluQ29uZmlnKTtcbiAgICB0aGlzLmN1cnJlbnRDaGFpbk5hbWVzcGFjZSA9IGN1c3RvbUNoYWluQ29uZmlnLmNoYWluTmFtZXNwYWNlO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdFdpdGhQcm92aWRlcihwYXJhbXMpIHtcbiAgICBpZiAoIXRoaXMuY2hhaW5Db25maWcpIHRocm93IFdhbGxldEluaXRpYWxpemF0aW9uRXJyb3IuaW52YWxpZFBhcmFtcyhcImNoYWluQ29uZmlnIGlzIHJlcXVpcmVkIGJlZm9yZSBpbml0aWFsaXphdGlvblwiKTtcbiAgICBpZiAoIXRoaXMub3BlbmxvZ2luSW5zdGFuY2UpIHRocm93IFdhbGxldEluaXRpYWxpemF0aW9uRXJyb3Iubm90UmVhZHkoXCJvcGVubG9naW5JbnN0YW5jZSBpcyBub3QgcmVhZHlcIik7XG5cbiAgICBpZiAodGhpcy5jdXJyZW50Q2hhaW5OYW1lc3BhY2UgPT09IENIQUlOX05BTUVTUEFDRVMuU09MQU5BKSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIFNvbGFuYVByaXZhdGVLZXlQcm92aWRlclxuICAgICAgfSA9IGF3YWl0IGltcG9ydCgnQHdlYjNhdXRoL3NvbGFuYS1wcm92aWRlcicpO1xuICAgICAgdGhpcy5wcml2S2V5UHJvdmlkZXIgPSBuZXcgU29sYW5hUHJpdmF0ZUtleVByb3ZpZGVyKHtcbiAgICAgICAgY29uZmlnOiB7XG4gICAgICAgICAgY2hhaW5Db25maWc6IHRoaXMuY2hhaW5Db25maWdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmN1cnJlbnRDaGFpbk5hbWVzcGFjZSA9PT0gQ0hBSU5fTkFNRVNQQUNFUy5FSVAxNTUpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgRXRoZXJldW1Qcml2YXRlS2V5UHJvdmlkZXJcbiAgICAgIH0gPSBhd2FpdCBpbXBvcnQoJ0B3ZWIzYXV0aC9ldGhlcmV1bS1wcm92aWRlcicpO1xuICAgICAgdGhpcy5wcml2S2V5UHJvdmlkZXIgPSBuZXcgRXRoZXJldW1Qcml2YXRlS2V5UHJvdmlkZXIoe1xuICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICBjaGFpbkNvbmZpZzogdGhpcy5jaGFpbkNvbmZpZ1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuY3VycmVudENoYWluTmFtZXNwYWNlID09PSBDSEFJTl9OQU1FU1BBQ0VTLk9USEVSKSB7XG4gICAgICB0aGlzLnByaXZLZXlQcm92aWRlciA9IG5ldyBDb21tb25Qcml2YXRlS2V5UHJvdmlkZXIoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBjaGFpbk5hbWVzcGFjZTogXCIuY29uY2F0KHRoaXMuY3VycmVudENoYWluTmFtZXNwYWNlLCBcIiBmb3VuZCB3aGlsZSBjb25uZWN0aW5nIHRvIHdhbGxldFwiKSk7XG4gICAgfSAvLyBpZiBub3QgbG9nZ2VkIGluIHRoZW4gbG9naW5cblxuXG4gICAgaWYgKCF0aGlzLm9wZW5sb2dpbkluc3RhbmNlLnByaXZLZXkgJiYgcGFyYW1zKSB7XG4gICAgICB2YXIgX3BhcmFtcyRleHRyYUxvZ2luT3B0O1xuXG4gICAgICBpZiAoIXRoaXMubG9naW5TZXR0aW5ncy5jdXJ2ZSkge1xuICAgICAgICB0aGlzLmxvZ2luU2V0dGluZ3MuY3VydmUgPSB0aGlzLmN1cnJlbnRDaGFpbk5hbWVzcGFjZSA9PT0gQ0hBSU5fTkFNRVNQQUNFUy5TT0xBTkEgPyBTVVBQT1JURURfS0VZX0NVUlZFUy5FRDI1NTE5IDogU1VQUE9SVEVEX0tFWV9DVVJWRVMuU0VDUDI1NksxO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLm9wZW5sb2dpbkluc3RhbmNlLmxvZ2luKG1lcmdlKHRoaXMubG9naW5TZXR0aW5ncywge1xuICAgICAgICBsb2dpblByb3ZpZGVyOiBwYXJhbXMubG9naW5Qcm92aWRlclxuICAgICAgfSwge1xuICAgICAgICBleHRyYUxvZ2luT3B0aW9uczogX29iamVjdFNwcmVhZChfb2JqZWN0U3ByZWFkKHt9LCBwYXJhbXMuZXh0cmFMb2dpbk9wdGlvbnMgfHwge30pLCB7fSwge1xuICAgICAgICAgIGxvZ2luX2hpbnQ6IHBhcmFtcy5sb2dpbl9oaW50IHx8ICgoX3BhcmFtcyRleHRyYUxvZ2luT3B0ID0gcGFyYW1zLmV4dHJhTG9naW5PcHRpb25zKSA9PT0gbnVsbCB8fCBfcGFyYW1zJGV4dHJhTG9naW5PcHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wYXJhbXMkZXh0cmFMb2dpbk9wdC5sb2dpbl9oaW50KVxuICAgICAgICB9KVxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIGxldCBmaW5hbFByaXZLZXkgPSB0aGlzLm9wZW5sb2dpbkluc3RhbmNlLnByaXZLZXk7XG5cbiAgICBpZiAoZmluYWxQcml2S2V5KSB7XG4gICAgICBpZiAodGhpcy5jdXJyZW50Q2hhaW5OYW1lc3BhY2UgPT09IENIQUlOX05BTUVTUEFDRVMuU09MQU5BKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICBnZXRFRDI1NTE5S2V5XG4gICAgICAgIH0gPSBhd2FpdCBpbXBvcnQoJ0B0b3J1c2xhYnMvb3BlbmxvZ2luLWVkMjU1MTknKTtcbiAgICAgICAgZmluYWxQcml2S2V5ID0gZ2V0RUQyNTUxOUtleShmaW5hbFByaXZLZXkpLnNrLnRvU3RyaW5nKFwiaGV4XCIpO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLnByaXZLZXlQcm92aWRlci5zZXR1cFByb3ZpZGVyKGZpbmFsUHJpdktleSk7XG4gICAgICB0aGlzLnN0YXR1cyA9IEFEQVBURVJfU1RBVFVTLkNPTk5FQ1RFRDtcbiAgICAgIHRoaXMuZW1pdChBREFQVEVSX0VWRU5UUy5DT05ORUNURUQsIHtcbiAgICAgICAgYWRhcHRlcjogV0FMTEVUX0FEQVBURVJTLk9QRU5MT0dJTixcbiAgICAgICAgcmVjb25uZWN0ZWQ6ICFwYXJhbXNcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG59XG5cbmV4cG9ydCB7IE9wZW5sb2dpbkFkYXB0ZXIsIGdldE9wZW5sb2dpbkRlZmF1bHRPcHRpb25zIH07XG4vLyMgc291cmNlTWFwcGluZ1VSTD1vcGVubG9naW5BZGFwdGVyLmVzbS5qcy5tYXBcbiJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==